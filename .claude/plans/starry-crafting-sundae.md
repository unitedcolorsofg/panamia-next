# Targeted Upstream Check for activities.next

## Problem

The current `upstream-check.yml` compares our subtree commit against upstream HEAD. Any change in activities.next (UI code, tests, docs, configs) triggers a warning — but we only care about the library code relevant to federation (ActivityPub protocol, HTTP signatures, data models). The UI/app code in activities.next is irrelevant since we never import it.

## Approach

1. Maintain a watch-list of paths within activities.next that matter to us
2. Compare git object hashes for only those paths between our subtree and upstream
3. Auto-create/update a GitHub Issue when changes are detected (more visible than workflow annotations)

### Watch List File — `.github/upstream-watched-paths.txt`

```
# Paths within activities.next to monitor for upstream changes.
# These are the library directories relevant to our federation layer.
# Update this file as new imports from activities.next are added.
#
# Format: one path per line, relative to activities.next root.
# Directories compare the full tree hash (any file change detected).
# Files compare individual blob hashes.

# Core ActivityPub activity handlers (Create, Follow, Like, etc.)
lib/activities/

# Data models (actor, status, attachment, follow, etc.)
lib/models/

# Backend services (HTTP signatures, delivery, WebFinger, etc.)
lib/services/

# Utility functions (text processing, signatures, etc.)
lib/utils/

# Shared constants and types
lib/constants.ts
```

Excluded (UI/app code we never import): `lib/components/`, `lib/actions/`, `lib/client.ts`, `lib/config/`, `lib/database/`, `lib/jobs/`, `lib/stub/`, `lib/testing/`, `lib/__mocks__/`.

### Workflow Changes — `.github/workflows/upstream-check.yml`

Replace the generic "is HEAD different?" check with per-path hash comparison, and create/update a GitHub Issue:

```yaml
- name: Check watched paths for upstream changes
  id: check-updates
  run: |
    WATCHED_PATHS_FILE=".github/upstream-watched-paths.txt"
    CHANGED=""
    TOTAL_CHECKED=0

    while IFS= read -r path; do
      # Skip comments and blank lines
      [[ "$path" =~ ^#.*$ || -z "$path" ]] && continue
      path=$(echo "$path" | xargs)  # trim whitespace

      LOCAL_HASH=$(git rev-parse "HEAD:external/activities.next/$path" 2>/dev/null || echo "missing")
      UPSTREAM_HASH=$(git rev-parse "activities-upstream/main:$path" 2>/dev/null || echo "missing")
      TOTAL_CHECKED=$((TOTAL_CHECKED + 1))

      if [ "$LOCAL_HASH" != "$UPSTREAM_HASH" ]; then
        CHANGED="$CHANGED- \`$path\`\n"
      fi
    done < "$WATCHED_PATHS_FILE"

    if [ -n "$CHANGED" ]; then
      echo "updates_available=true" >> $GITHUB_OUTPUT
      {
        echo "changed_paths<<EOF"
        echo -e "$CHANGED"
        echo "EOF"
      } >> $GITHUB_OUTPUT
    else
      echo "updates_available=false" >> $GITHUB_OUTPUT
    fi
    echo "Checked $TOTAL_CHECKED watched paths"

- name: Create or update GitHub Issue
  if: steps.check-updates.outputs.updates_available == 'true'
  uses: actions/github-script@v7
  with:
    script: |
      const title = 'Upstream activities.next has federation-relevant updates';
      const changedPaths = `${{ steps.check-updates.outputs.changed_paths }}`;
      const body = `## Upstream Changes Detected

The following watched paths have changed in [activities.next](https://github.com/llun/activities.next):

${changedPaths}

### Action Required

Review upstream changes and update subtree if needed:
\`\`\`bash
git subtree pull --prefix=external/activities.next activities-upstream main --squash
\`\`\`

---
*Auto-generated by upstream-check workflow on ${new Date().toISOString().split('T')[0]}*`;

      // Search for existing open issue with the label
      const issues = await github.rest.issues.listForRepo({
        owner: context.repo.owner,
        repo: context.repo.repo,
        state: 'open',
        labels: 'upstream-update',
        per_page: 1
      });

      if (issues.data.length > 0) {
        // Update existing issue
        await github.rest.issues.update({
          owner: context.repo.owner,
          repo: context.repo.repo,
          issue_number: issues.data[0].number,
          body: body
        });
        console.log(`Updated issue #${issues.data[0].number}`);
      } else {
        // Create new issue
        const newIssue = await github.rest.issues.create({
          owner: context.repo.owner,
          repo: context.repo.repo,
          title: title,
          body: body,
          labels: ['upstream-update', 'federation']
        });
        console.log(`Created issue #${newIssue.data.number}`);
      }

- name: Close issue if no updates
  if: steps.check-updates.outputs.updates_available == 'false'
  uses: actions/github-script@v7
  with:
    script: |
      const issues = await github.rest.issues.listForRepo({
        owner: context.repo.owner,
        repo: context.repo.repo,
        state: 'open',
        labels: 'upstream-update',
        per_page: 1
      });

      if (issues.data.length > 0) {
        await github.rest.issues.update({
          owner: context.repo.owner,
          repo: context.repo.repo,
          issue_number: issues.data[0].number,
          state: 'closed',
          state_reason: 'completed'
        });
        console.log(`Closed issue #${issues.data[0].number} - subtree is up to date`);
      }
```

### Triggers

Keep all three triggers:

- **push/PR** on `external/activities.next/**` — verify our subtree update; closes issue if now up-to-date
- **schedule** (weekly) — check if upstream has changes to watched paths; creates/updates issue

## Files

| File                                   | Action                                                          |
| -------------------------------------- | --------------------------------------------------------------- |
| `.github/upstream-watched-paths.txt`   | **Create** — list of watched paths                              |
| `.github/workflows/upstream-check.yml` | **Modify** — per-path hash comparison + GitHub Issue management |
